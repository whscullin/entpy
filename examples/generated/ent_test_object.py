####################
# Code generated by EntPy - do not modify manually!
####################

from __future__ import annotations
from entpy import (
    Ent,
    generate_uuid,
    EntNotFoundError,
    ExecutionError,
    Action,
    Decision,
    ValidationError,
)
from uuid import UUID
from datetime import datetime, UTC
from evc import ExampleViewerContext
from database import get_session
from .ent_query import EntQuery
from .ent_test_thing import EntTestThingModel
from .ent_test_thing import IEntTestThing
from .ent_test_thing import IEntTestThingMutatorDeletionAction
from .ent_test_thing import IEntTestThingMutatorUpdateAction
from datetime import time
from ent_test_object_schema import EntTestObjectSchema
from ent_test_object_schema import Status
from ent_test_thing_pattern import ThingStatus
from entpy import Field, FieldWithDynamicExample
from entpy.types import DateTime
from sentinels import NOTHING, Sentinel  # type: ignore[import-untyped]
from sqlalchemy import Boolean
from sqlalchemy import Enum as DBEnum
from sqlalchemy import ForeignKey
from sqlalchemy import Integer
from sqlalchemy import JSON
from sqlalchemy import String
from sqlalchemy import Text
from sqlalchemy import Time
from sqlalchemy import UUID as DBUUID
from sqlalchemy import select
from sqlalchemy import func, Result
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy.orm import Mapped, mapped_column
from typing import TypeVar
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from .ent_test_object5 import EntTestObject5
    from .ent_test_sub_object import EntTestSubObject
    from .ent_test_thing import IEntTestThing


class EntTestObjectModel(EntTestThingModel):
    __tablename__ = "test_object"

    firstname: Mapped[str] = mapped_column(String(100), nullable=False, index=True)
    required_sub_object_id: Mapped[UUID] = mapped_column(
        DBUUID(),
        ForeignKey("test_sub_object.id", deferrable=True, initially="DEFERRED"),
        nullable=False,
    )
    username: Mapped[str] = mapped_column(String(100), nullable=False, unique=True)
    lastname: Mapped[str | None] = mapped_column(
        String(100), nullable=True, server_default="Doe"
    )
    sadness: Mapped[Status | None] = mapped_column(
        DBEnum(Status, native_enum=True), nullable=True, server_default=Status.SAD.value
    )
    city: Mapped[str | None] = mapped_column(String(100), nullable=True)
    context: Mapped[str | None] = mapped_column(Text(), nullable=True)
    correlation_id: Mapped[UUID | None] = mapped_column(DBUUID(), nullable=True)
    end_time: Mapped[time | None] = mapped_column(Time(), nullable=True)
    is_it_true: Mapped[bool | None] = mapped_column(Boolean(), nullable=True)
    optional_sub_object_id: Mapped[UUID | None] = mapped_column(
        DBUUID(),
        ForeignKey("test_sub_object.id", deferrable=True, initially="DEFERRED"),
        nullable=True,
    )
    optional_sub_object_no_ex_id: Mapped[UUID | None] = mapped_column(
        DBUUID(),
        ForeignKey("test_sub_object.id", deferrable=True, initially="DEFERRED"),
        nullable=True,
    )
    self_id: Mapped[UUID | None] = mapped_column(
        DBUUID(),
        ForeignKey("test_object.id", deferrable=True, initially="DEFERRED"),
        nullable=True,
    )
    some_json: Mapped[list[str] | None] = mapped_column(
        JSON().with_variant(JSONB(), "postgresql"), nullable=True
    )
    some_pattern_id: Mapped[UUID | None] = mapped_column(DBUUID(), nullable=True)
    start_time: Mapped[time | None] = mapped_column(Time(), nullable=True)
    status: Mapped[Status | None] = mapped_column(
        DBEnum(Status, native_enum=True), nullable=True
    )
    status_code: Mapped[int | None] = mapped_column(Integer(), nullable=True)
    trace_id: Mapped[UUID | None] = mapped_column(DBUUID(), nullable=True)
    validated_field: Mapped[str | None] = mapped_column(String(100), nullable=True)
    when_is_it_cool: Mapped[datetime | None] = mapped_column(DateTime(), nullable=True)


class EntTestObject(IEntTestThing, Ent[ExampleViewerContext]):
    """
    This is an object we use to test all the ent framework features!
    """

    vc: ExampleViewerContext
    model: EntTestObjectModel

    def __init__(self, vc: ExampleViewerContext, model: EntTestObjectModel) -> None:
        self.vc = vc
        self.model = model

    @property
    def id(self) -> UUID:
        return self.model.id

    @property
    def created_at(self) -> datetime:
        return self.model.created_at

    @property
    def updated_at(self) -> datetime:
        return self.model.updated_at

    @property
    def a_good_thing(self) -> str:
        return self.model.a_good_thing

    @property
    def firstname(self) -> str:
        return self.model.firstname

    @property
    def obj5_id(self) -> UUID:
        return self.model.obj5_id

    async def gen_obj5(self) -> EntTestObject5:
        from .ent_test_object5 import EntTestObject5

        return await EntTestObject5.genx(self.vc, self.model.obj5_id)

    @property
    def required_sub_object_id(self) -> UUID:
        return self.model.required_sub_object_id

    async def gen_required_sub_object(self) -> EntTestSubObject:
        from .ent_test_sub_object import EntTestSubObject

        return await EntTestSubObject.genx(self.vc, self.model.required_sub_object_id)

    @property
    def username(self) -> str:
        """
        This is the username that you will use on the platform.
        """
        return self.model.username

    @property
    def lastname(self) -> str | None:
        return self.model.lastname

    @property
    def sadness(self) -> Status | None:
        return self.model.sadness

    @property
    def a_pattern_validated_field(self) -> str | None:
        return self.model.a_pattern_validated_field

    @property
    def city(self) -> str | None:
        return self.model.city

    @property
    def context(self) -> str | None:
        return self.model.context

    @property
    def correlation_id(self) -> UUID | None:
        return self.model.correlation_id

    @property
    def end_time(self) -> time | None:
        return self.model.end_time

    @property
    def is_it_true(self) -> bool | None:
        return self.model.is_it_true

    @property
    def obj5_opt_id(self) -> UUID | None:
        return self.model.obj5_opt_id

    async def gen_obj5_opt(self) -> "EntTestObject5" | None:
        from .ent_test_object5 import EntTestObject5

        if self.model.obj5_opt_id:
            return await EntTestObject5.gen(self.vc, self.model.obj5_opt_id)
        return None

    @property
    def optional_sub_object_id(self) -> UUID | None:
        return self.model.optional_sub_object_id

    async def gen_optional_sub_object(self) -> "EntTestSubObject" | None:
        from .ent_test_sub_object import EntTestSubObject

        if self.model.optional_sub_object_id:
            return await EntTestSubObject.gen(
                self.vc, self.model.optional_sub_object_id
            )
        return None

    @property
    def optional_sub_object_no_ex_id(self) -> UUID | None:
        return self.model.optional_sub_object_no_ex_id

    async def gen_optional_sub_object_no_ex(self) -> "EntTestSubObject" | None:
        from .ent_test_sub_object import EntTestSubObject

        if self.model.optional_sub_object_no_ex_id:
            return await EntTestSubObject.gen(
                self.vc, self.model.optional_sub_object_no_ex_id
            )
        return None

    @property
    def self_id(self) -> UUID | None:
        return self.model.self_id

    async def gen_self(self) -> "EntTestObject" | None:

        if self.model.self_id:
            return await EntTestObject.gen(self.vc, self.model.self_id)
        return None

    @property
    def some_json(self) -> list[str] | None:
        return self.model.some_json

    @property
    def some_pattern_id(self) -> UUID | None:
        return self.model.some_pattern_id

    async def gen_some_pattern(self) -> "IEntTestThing" | None:
        from .ent_test_thing import IEntTestThing

        if self.model.some_pattern_id:
            return await IEntTestThing.gen(self.vc, self.model.some_pattern_id)
        return None

    @property
    def start_time(self) -> time | None:
        return self.model.start_time

    @property
    def status(self) -> Status | None:
        return self.model.status

    @property
    def status_code(self) -> int | None:
        return self.model.status_code

    @property
    def thing_status(self) -> ThingStatus | None:
        return self.model.thing_status

    @property
    def trace_id(self) -> UUID | None:
        return self.model.trace_id

    @property
    def validated_field(self) -> str | None:
        return self.model.validated_field

    @property
    def when_is_it_cool(self) -> datetime | None:
        return self.model.when_is_it_cool

    async def _gen_evaluate_privacy(
        self, vc: ExampleViewerContext, action: Action
    ) -> Decision:
        rules = EntTestObjectSchema().get_privacy_rules(action)
        for rule in rules:
            decision = await rule.gen_evaluate(vc, self)
            # If we get an ALLOW or DENY, we return instantly. Else, we keep going.
            if decision != Decision.PASS:
                return decision
        # We default to denying
        return Decision.DENY

    @classmethod
    async def genx(cls, vc: ExampleViewerContext, ent_id: UUID | str) -> EntTestObject:
        ent = await cls.gen(vc, ent_id)
        if not ent:
            raise EntNotFoundError(f"No EntTestObject found for ID {ent_id}")
        return ent

    @classmethod
    async def gen(
        cls, vc: ExampleViewerContext, ent_id: UUID | str
    ) -> EntTestObject | None:
        # Convert str to UUID if needed
        if isinstance(ent_id, str):
            try:
                ent_id = UUID(ent_id)
            except ValueError as e:
                raise ValidationError(f"Invalid ID format for {ent_id}") from e

        session = get_session()
        model = await session.get(EntTestObjectModel, ent_id)
        return await cls._gen_from_model(vc, model)  # noqa: SLF001

    @classmethod
    async def gen_from_username(
        cls, vc: ExampleViewerContext, username: str
    ) -> EntTestObject | None:
        session = get_session()
        result = await session.execute(
            select(EntTestObjectModel).where(EntTestObjectModel.username == username)
        )
        model = result.scalar_one_or_none()
        return await cls._gen_from_model(vc, model)  # noqa: SLF001

    @classmethod
    async def genx_from_username(
        cls, vc: ExampleViewerContext, username: str
    ) -> EntTestObject:
        result = await cls.gen_from_username(vc, username)
        if not result:
            raise EntNotFoundError(f"No EntTestObject found for username {username}")
        return result

    @classmethod
    async def _gen_from_model(
        cls, vc: ExampleViewerContext, model: EntTestObjectModel | None
    ) -> EntTestObject | None:
        if not model:
            return None
        ent = EntTestObject(vc=vc, model=model)
        decision = await ent._gen_evaluate_privacy(vc=vc, action=Action.READ)
        return ent if decision == Decision.ALLOW else None

    @classmethod
    async def _genx_from_model(
        cls, vc: ExampleViewerContext, model: EntTestObjectModel
    ) -> EntTestObject:
        ent = await EntTestObject._gen_from_model(vc=vc, model=model)
        if not ent:
            raise EntNotFoundError(f"No EntTestObject found for ID {model.id}")
        return ent

    @classmethod
    def query(cls, vc: ExampleViewerContext) -> EntTestObjectQuery:
        return EntTestObjectQuery(vc=vc)


T = TypeVar("T")


class EntTestObjectQuery(EntQuery[EntTestObject, EntTestObjectModel]):
    vc: ExampleViewerContext

    def __init__(self, vc: ExampleViewerContext) -> None:
        self.vc = vc

        self.query = select(EntTestObjectModel)

    async def gen(self) -> list[EntTestObject]:
        session = get_session()
        result = await session.execute(self.query)
        ents = await self._gen_ents(result)
        return list(filter(None, ents))

    async def _gen_ents(
        self, result: Result[tuple[EntTestObjectModel]]
    ) -> list[EntTestObject | None]:
        models = result.scalars().all()
        return [
            await EntTestObject._gen_from_model(self.vc, model)  # noqa: SLF001
            for model in models
        ]

    async def gen_first(self) -> EntTestObject | None:
        session = get_session()
        result = await session.execute(self.query.limit(1))
        return await self._gen_ent(result)

    async def _gen_ent(
        self, result: Result[tuple[EntTestObjectModel]]
    ) -> EntTestObject | None:
        model = result.scalar_one_or_none()
        return await EntTestObject._gen_from_model(self.vc, model)  # noqa: SLF001

    async def genx_first(self) -> EntTestObject:
        ent = await self.gen_first()
        if not ent:
            raise EntNotFoundError("Expected query to return an ent, got None.")
        return ent

    async def gen_count_NO_PRIVACY(self) -> int:
        session = get_session()
        count_query = self.query.with_only_columns(
            func.count(), maintain_column_froms=True
        ).order_by(None)
        result = await session.execute(count_query)
        count = result.scalar()
        if count is None:
            raise ExecutionError("Unable to get the count")
        return count

    def order_by_id_asc(self) -> "EntTestObjectQuery":
        self.query = self.query.order_by(EntTestObjectModel.id.asc())
        return self

    def order_by_id_desc(self) -> "EntTestObjectQuery":
        self.query = self.query.order_by(EntTestObjectModel.id.desc())
        return self


class EntTestObjectMutator:
    @classmethod
    def create(
        cls,
        vc: ExampleViewerContext,
        a_good_thing: str,
        firstname: str,
        obj5_id: UUID,
        required_sub_object_id: UUID,
        username: str,
        lastname: str | None = None,
        sadness: Status | None = None,
        a_pattern_validated_field: str | None = None,
        city: str | None = None,
        context: str | None = None,
        correlation_id: UUID | None = None,
        end_time: time | None = None,
        is_it_true: bool | None = None,
        obj5_opt_id: UUID | None = None,
        optional_sub_object_id: UUID | None = None,
        optional_sub_object_no_ex_id: UUID | None = None,
        self_id: UUID | None = None,
        some_json: list[str] | None = None,
        some_pattern_id: UUID | None = None,
        start_time: time | None = None,
        status: Status | None = None,
        status_code: int | None = None,
        thing_status: ThingStatus | None = None,
        trace_id: UUID | None = None,
        validated_field: str | None = None,
        when_is_it_cool: datetime | None = None,
        id: UUID | None = None,
        created_at: datetime | None = None,
        updated_at: datetime | None = None,
    ) -> EntTestObjectMutatorCreationAction:
        return EntTestObjectMutatorCreationAction(
            vc=vc,
            id=id,
            created_at=created_at,
            updated_at=updated_at,
            a_good_thing=a_good_thing,
            firstname=firstname,
            obj5_id=obj5_id,
            required_sub_object_id=required_sub_object_id,
            username=username,
            lastname=lastname,
            sadness=sadness,
            a_pattern_validated_field=a_pattern_validated_field,
            city=city,
            context=context,
            correlation_id=correlation_id,
            end_time=end_time,
            is_it_true=is_it_true,
            obj5_opt_id=obj5_opt_id,
            optional_sub_object_id=optional_sub_object_id,
            optional_sub_object_no_ex_id=optional_sub_object_no_ex_id,
            self_id=self_id,
            some_json=some_json,
            some_pattern_id=some_pattern_id,
            start_time=start_time,
            status=status,
            status_code=status_code,
            thing_status=thing_status,
            trace_id=trace_id,
            validated_field=validated_field,
            when_is_it_cool=when_is_it_cool,
        )

    @classmethod
    def update(
        cls, vc: ExampleViewerContext, ent: EntTestObject
    ) -> EntTestObjectMutatorUpdateAction:
        return EntTestObjectMutatorUpdateAction(vc=vc, ent=ent)

    @classmethod
    def delete(
        cls, vc: ExampleViewerContext, ent: EntTestObject
    ) -> EntTestObjectMutatorDeletionAction:
        return EntTestObjectMutatorDeletionAction(vc=vc, ent=ent)


class EntTestObjectMutatorCreationAction:
    vc: ExampleViewerContext
    id: UUID
    a_good_thing: str
    firstname: str
    obj5_id: UUID
    required_sub_object_id: UUID
    username: str
    lastname: str | None = None
    sadness: Status | None = None
    a_pattern_validated_field: str | None = None
    city: str | None = None
    context: str | None = None
    correlation_id: UUID | None = None
    end_time: time | None = None
    is_it_true: bool | None = None
    obj5_opt_id: UUID | None = None
    optional_sub_object_id: UUID | None = None
    optional_sub_object_no_ex_id: UUID | None = None
    self_id: UUID | None = None
    some_json: list[str] | None = None
    some_pattern_id: UUID | None = None
    start_time: time | None = None
    status: Status | None = None
    status_code: int | None = None
    thing_status: ThingStatus | None = None
    trace_id: UUID | None = None
    validated_field: str | None = None
    when_is_it_cool: datetime | None = None

    def __init__(
        self,
        vc: ExampleViewerContext,
        id: UUID | None,
        created_at: datetime | None,
        updated_at: datetime | None,
        a_good_thing: str,
        firstname: str,
        obj5_id: UUID,
        required_sub_object_id: UUID,
        username: str,
        lastname: str | None,
        sadness: Status | None,
        a_pattern_validated_field: str | None,
        city: str | None,
        context: str | None,
        correlation_id: UUID | None,
        end_time: time | None,
        is_it_true: bool | None,
        obj5_opt_id: UUID | None,
        optional_sub_object_id: UUID | None,
        optional_sub_object_no_ex_id: UUID | None,
        self_id: UUID | None,
        some_json: list[str] | None,
        some_pattern_id: UUID | None,
        start_time: time | None,
        status: Status | None,
        status_code: int | None,
        thing_status: ThingStatus | None,
        trace_id: UUID | None,
        validated_field: str | None,
        when_is_it_cool: datetime | None,
    ) -> None:
        self.vc = vc
        self.created_at = created_at if created_at else datetime.now(tz=UTC)
        self.updated_at = updated_at if updated_at else self.created_at
        self.id = id if id else generate_uuid(EntTestObject, self.created_at)
        self.a_good_thing = a_good_thing
        self.firstname = firstname
        self.obj5_id = obj5_id
        self.required_sub_object_id = required_sub_object_id
        self.username = username
        self.lastname = lastname
        self.sadness = sadness
        self.a_pattern_validated_field = a_pattern_validated_field
        self.city = city
        self.context = context
        self.correlation_id = correlation_id
        self.end_time = end_time
        self.is_it_true = is_it_true
        self.obj5_opt_id = obj5_opt_id
        self.optional_sub_object_id = optional_sub_object_id
        self.optional_sub_object_no_ex_id = optional_sub_object_no_ex_id
        self.self_id = self_id
        self.some_json = some_json
        self.some_pattern_id = some_pattern_id
        self.start_time = start_time
        self.status = status
        self.status_code = status_code
        self.thing_status = thing_status
        self.trace_id = trace_id
        self.validated_field = validated_field
        self.when_is_it_cool = when_is_it_cool

    async def gen_savex(self) -> EntTestObject:
        session = get_session()

        a_pattern_validated_field_validators = _get_field(
            "a_pattern_validated_field"
        )._validators  # noqa: SLF001
        for validator in a_pattern_validated_field_validators:
            if not validator.validate(self.a_pattern_validated_field):
                raise ValidationError(
                    "Invalid value for EntTestObject.a_pattern_validated_field"
                )

        validated_field_validators = _get_field("validated_field")._validators  # noqa: SLF001
        for validator in validated_field_validators:
            if not validator.validate(self.validated_field):
                raise ValidationError("Invalid value for EntTestObject.validated_field")

        model = EntTestObjectModel(
            id=self.id,
            updated_at=self.updated_at,
            created_at=self.created_at,
            a_good_thing=self.a_good_thing,
            firstname=self.firstname,
            obj5_id=self.obj5_id,
            required_sub_object_id=self.required_sub_object_id,
            username=self.username,
            lastname=self.lastname,
            sadness=self.sadness,
            a_pattern_validated_field=self.a_pattern_validated_field,
            city=self.city,
            context=self.context,
            correlation_id=self.correlation_id,
            end_time=self.end_time,
            is_it_true=self.is_it_true,
            obj5_opt_id=self.obj5_opt_id,
            optional_sub_object_id=self.optional_sub_object_id,
            optional_sub_object_no_ex_id=self.optional_sub_object_no_ex_id,
            self_id=self.self_id,
            some_json=self.some_json,
            some_pattern_id=self.some_pattern_id,
            start_time=self.start_time,
            status=self.status,
            status_code=self.status_code,
            thing_status=self.thing_status,
            trace_id=self.trace_id,
            validated_field=self.validated_field,
            when_is_it_cool=self.when_is_it_cool,
        )
        session.add(model)
        await session.flush()
        # TODO privacy checks
        return await EntTestObject._genx_from_model(self.vc, model)  # noqa: SLF001


class EntTestObjectMutatorUpdateAction(IEntTestThingMutatorUpdateAction):
    vc: ExampleViewerContext
    ent: EntTestObject
    id: UUID
    a_good_thing: str
    firstname: str
    obj5_id: UUID
    required_sub_object_id: UUID
    username: str
    lastname: str | None = None
    sadness: Status | None = None
    a_pattern_validated_field: str | None = None
    city: str | None = None
    correlation_id: UUID | None = None
    end_time: time | None = None
    is_it_true: bool | None = None
    obj5_opt_id: UUID | None = None
    optional_sub_object_id: UUID | None = None
    optional_sub_object_no_ex_id: UUID | None = None
    self_id: UUID | None = None
    some_json: list[str] | None = None
    some_pattern_id: UUID | None = None
    start_time: time | None = None
    status: Status | None = None
    status_code: int | None = None
    thing_status: ThingStatus | None = None
    trace_id: UUID | None = None
    validated_field: str | None = None
    when_is_it_cool: datetime | None = None

    def __init__(self, vc: ExampleViewerContext, ent: EntTestObject) -> None:
        self.vc = vc
        self.ent = ent
        self.a_good_thing = ent.a_good_thing
        self.firstname = ent.firstname
        self.obj5_id = ent.obj5_id
        self.required_sub_object_id = ent.required_sub_object_id
        self.username = ent.username
        self.lastname = ent.lastname
        self.sadness = ent.sadness
        self.a_pattern_validated_field = ent.a_pattern_validated_field
        self.city = ent.city
        self.correlation_id = ent.correlation_id
        self.end_time = ent.end_time
        self.is_it_true = ent.is_it_true
        self.obj5_opt_id = ent.obj5_opt_id
        self.optional_sub_object_id = ent.optional_sub_object_id
        self.optional_sub_object_no_ex_id = ent.optional_sub_object_no_ex_id
        self.self_id = ent.self_id
        self.some_json = ent.some_json
        self.some_pattern_id = ent.some_pattern_id
        self.start_time = ent.start_time
        self.status = ent.status
        self.status_code = ent.status_code
        self.thing_status = ent.thing_status
        self.trace_id = ent.trace_id
        self.validated_field = ent.validated_field
        self.when_is_it_cool = ent.when_is_it_cool

    async def gen_savex(self) -> EntTestObject:
        session = get_session()

        a_pattern_validated_field_validators = _get_field(
            "a_pattern_validated_field"
        )._validators  # noqa: SLF001
        for validator in a_pattern_validated_field_validators:
            if not validator.validate(self.a_pattern_validated_field):
                raise ValidationError(
                    "Invalid value for EntTestObject.a_pattern_validated_field"
                )

        validated_field_validators = _get_field("validated_field")._validators  # noqa: SLF001
        for validator in validated_field_validators:
            if not validator.validate(self.validated_field):
                raise ValidationError("Invalid value for EntTestObject.validated_field")

        model = self.ent.model
        model.a_good_thing = self.a_good_thing
        model.firstname = self.firstname
        model.obj5_id = self.obj5_id
        model.required_sub_object_id = self.required_sub_object_id
        model.username = self.username
        model.lastname = self.lastname
        model.sadness = self.sadness
        model.a_pattern_validated_field = self.a_pattern_validated_field
        model.city = self.city
        model.correlation_id = self.correlation_id
        model.end_time = self.end_time
        model.is_it_true = self.is_it_true
        model.obj5_opt_id = self.obj5_opt_id
        model.optional_sub_object_id = self.optional_sub_object_id
        model.optional_sub_object_no_ex_id = self.optional_sub_object_no_ex_id
        model.self_id = self.self_id
        model.some_json = self.some_json
        model.some_pattern_id = self.some_pattern_id
        model.start_time = self.start_time
        model.status = self.status
        model.status_code = self.status_code
        model.thing_status = self.thing_status
        model.trace_id = self.trace_id
        model.validated_field = self.validated_field
        model.when_is_it_cool = self.when_is_it_cool
        model.updated_at = datetime.now(tz=UTC)
        session.add(model)
        await session.flush()
        await session.refresh(model)
        # TODO privacy checks
        return await EntTestObject._genx_from_model(self.vc, model)  # noqa: SLF001


class EntTestObjectMutatorDeletionAction(IEntTestThingMutatorDeletionAction):
    vc: ExampleViewerContext
    ent: EntTestObject

    def __init__(self, vc: ExampleViewerContext, ent: EntTestObject) -> None:
        self.vc = vc
        self.ent = ent

    async def gen_save(self) -> None:
        session = get_session()
        model = self.ent.model
        # TODO privacy checks
        await session.delete(model)
        await session.flush()


class EntTestObjectExample:
    @classmethod
    async def gen_create(
        cls,
        vc: ExampleViewerContext,
        created_at: datetime | None = None,
        a_good_thing: str | Sentinel = NOTHING,
        firstname: str | Sentinel = NOTHING,
        obj5_id: UUID | Sentinel = NOTHING,
        required_sub_object_id: UUID | Sentinel = NOTHING,
        username: str | Sentinel = NOTHING,
        lastname: str | None = None,
        sadness: Status | None = None,
        a_pattern_validated_field: str | Sentinel = NOTHING,
        city: str | Sentinel = NOTHING,
        context: str | Sentinel = NOTHING,
        correlation_id: UUID | Sentinel = NOTHING,
        end_time: time | Sentinel = NOTHING,
        is_it_true: bool | Sentinel = NOTHING,
        obj5_opt_id: UUID | None = None,
        optional_sub_object_id: UUID | None = None,
        optional_sub_object_no_ex_id: UUID | None = None,
        self_id: UUID | None = None,
        some_json: list[str] | Sentinel = NOTHING,
        some_pattern_id: UUID | None = None,
        start_time: time | Sentinel = NOTHING,
        status: Status | Sentinel = NOTHING,
        status_code: int | Sentinel = NOTHING,
        thing_status: ThingStatus | None = None,
        trace_id: UUID | Sentinel = NOTHING,
        validated_field: str | None = None,
        when_is_it_cool: datetime | Sentinel = NOTHING,
    ) -> EntTestObject:
        # TODO make sure we only use this in test mode

        a_good_thing = (
            "A sunny day" if isinstance(a_good_thing, Sentinel) else a_good_thing
        )

        firstname = "Vincent" if isinstance(firstname, Sentinel) else firstname

        if isinstance(obj5_id, Sentinel) or obj5_id is None:
            from .ent_test_object5 import EntTestObject5Example

            obj5_id_ent = await EntTestObject5Example.gen_create(vc)
            obj5_id = obj5_id_ent.id

        if (
            isinstance(required_sub_object_id, Sentinel)
            or required_sub_object_id is None
        ):
            from .ent_test_sub_object import EntTestSubObjectExample

            required_sub_object_id_ent = await EntTestSubObjectExample.gen_create(vc)
            required_sub_object_id = required_sub_object_id_ent.id

        if isinstance(username, Sentinel):
            field = _get_field("username")
            if not isinstance(field, FieldWithDynamicExample):
                raise TypeError(
                    "Internal ent error: Field {field.name} must support dynamic examples."
                )
            generator = field.get_example_generator()
            if generator:
                username = generator()

        lastname = "Doe" if isinstance(lastname, Sentinel) else lastname

        sadness = Status.SAD if isinstance(sadness, Sentinel) else sadness

        a_pattern_validated_field = (
            "vdurmont"
            if isinstance(a_pattern_validated_field, Sentinel)
            else a_pattern_validated_field
        )

        city = "Los Angeles" if isinstance(city, Sentinel) else city

        context = (
            "This is some good context." if isinstance(context, Sentinel) else context
        )

        correlation_id = (
            UUID("b95915f7-7355-4973-8b13-75e530d3b534")
            if isinstance(correlation_id, Sentinel)
            else correlation_id
        )

        if isinstance(end_time, Sentinel):
            field = _get_field("end_time")
            if not isinstance(field, FieldWithDynamicExample):
                raise TypeError(
                    "Internal ent error: Field {field.name} must support dynamic examples."
                )
            generator = field.get_example_generator()
            if generator:
                end_time = generator()

        is_it_true = False if isinstance(is_it_true, Sentinel) else is_it_true

        if isinstance(obj5_opt_id, Sentinel) or obj5_opt_id is None:
            from .ent_test_object5 import EntTestObject5Example

            obj5_opt_id_ent = await EntTestObject5Example.gen_create(vc)
            obj5_opt_id = obj5_opt_id_ent.id

        if (
            isinstance(optional_sub_object_id, Sentinel)
            or optional_sub_object_id is None
        ):
            from .ent_test_sub_object import EntTestSubObjectExample

            optional_sub_object_id_ent = await EntTestSubObjectExample.gen_create(vc)
            optional_sub_object_id = optional_sub_object_id_ent.id
        some_json = ["hello", "world"] if isinstance(some_json, Sentinel) else some_json

        start_time = (
            time.fromisoformat("09:30:00")
            if isinstance(start_time, Sentinel)
            else start_time
        )

        status = Status.HAPPY if isinstance(status, Sentinel) else status

        status_code = 404 if isinstance(status_code, Sentinel) else status_code

        if isinstance(trace_id, Sentinel):
            field = _get_field("trace_id")
            if not isinstance(field, FieldWithDynamicExample):
                raise TypeError(
                    "Internal ent error: Field {field.name} must support dynamic examples."
                )
            generator = field.get_example_generator()
            if generator:
                trace_id = generator()

        if isinstance(when_is_it_cool, Sentinel):
            field = _get_field("when_is_it_cool")
            if not isinstance(field, FieldWithDynamicExample):
                raise TypeError(
                    "Internal ent error: Field {field.name} must support dynamic examples."
                )
            generator = field.get_example_generator()
            if generator:
                when_is_it_cool = generator()

        return await EntTestObjectMutator.create(
            vc=vc,
            created_at=created_at,
            a_good_thing=a_good_thing,
            firstname=firstname,
            obj5_id=obj5_id,
            required_sub_object_id=required_sub_object_id,
            username=username,
            lastname=lastname,
            sadness=sadness,
            a_pattern_validated_field=a_pattern_validated_field,
            city=city,
            context=context,
            correlation_id=correlation_id,
            end_time=end_time,
            is_it_true=is_it_true,
            obj5_opt_id=obj5_opt_id,
            optional_sub_object_id=optional_sub_object_id,
            optional_sub_object_no_ex_id=optional_sub_object_no_ex_id,
            self_id=self_id,
            some_json=some_json,
            some_pattern_id=some_pattern_id,
            start_time=start_time,
            status=status,
            status_code=status_code,
            thing_status=thing_status,
            trace_id=trace_id,
            validated_field=validated_field,
            when_is_it_cool=when_is_it_cool,
        ).gen_savex()


def _get_field(field_name: str) -> Field:
    schema = EntTestObjectSchema()
    fields = schema.get_all_fields()
    field = next(
        filter(
            lambda field: field.name == field_name,
            fields,
        )
    )
    if not field:
        raise ValueError(f"Unknown field: {field_name}")
    return field
